# D3js.github.io
Samples for presentation


D3.js что это и с чем его едят
D3.js представляет библиотеку на языке JavaScript для обработки и визуализации данных. Она основана прежде всего на использовании JavaScript, SVG и CSS. Само название D3 расшифровывается как Data-Driven Documents и как бы делает упор на управление данными, хотя ключевой функциональностью библиотеки являются мощные возможности для их визуализации.

Начнем мы наше знакомство с этой библиотекой с выборки данных. Выборка элементов является одной из первостепенных задач при работе с D3.js, так как чтобы создать графику, надо предварительно выбрать элемент, в котором эта графика будет размещаться.

Чтобы выбрать определенный элемент из структуры DOM, необходимо использовать селектор. Селектор представляет собой некий шаблон, которому должны соответствовать элементы. В качестве селекторов здесь также, как и в jQuery, применяются css-селекторы.

Для выборки D3.js предоставляет два метода:
    d3.select("selector"): возвращает первый элемент из всех элементов, которые соответствуют селектору
    d3.selectAll("selector"): возвращает все элементы, которые соответствуют селектору.

При этом мы можем использовать последовательно несколько уровней выборки:
    d3.select('body').select('div.blue');
В данном случае сначала выбирается элемент body, потом из его элементов выбирается элемент div с классом blue.

Операторы
Операторы представляют методы, которые проводят различные операции над выборкой. Существует несколько основных операторов:

    attr(): получает или устанавливает значение атрибута

    style(): получает или устанавливает стиль элемента

    text(): получает или устанавливает текстовое содержимое

    html(): получает или устанавливает html-код элемента

Оператор text()
Получение текста:
    var innerText = d3.select("div.red").text();
    console.log(innerText);

Установка текста:
    d3.select("div.red").text("Первый элемент div.red");

Оператор attr()
Получение значение атрибута (на примере атрибута class):
    var attrValue = d3.select("div").attr("class");
    console.log(attrValue);

Установка значения атрибута:
    d3.select("div").attr("class", "blue")

Оператор style()
Установка стиля:
    d3.select("div.red").style("width", "50px").style("height", "100px")
    .style("border", "solid 1px black").style("color", "red");
С помощью цепочки вызовов устанавливаем стили для ширины, высоты, границы и цвета текста

Получение стиля:
    var width = d3.select("div.red").style("width");
    console.log(width);

Оператор html()
Установка кода html:
    d3.select("div.red").html("<h1>Заголовок</h1><p>Абзац</p>");

Получение html:
    var htmlCode = d3.select("div.red").html();
    console.log(htmlCode);
    
Управление html-кодом элементов
Для создания новых элементов D3.js применяет ряд операторов, среди которых самыми распространенными являются следующие:

    append(): добавляет новый элемент, тег которого передается в метод в качестве параметра

    insert(): добавляет новый элемент по определенной позиции

    remove(): удаляет элемент
    
Добавление элемента
Добавим в элемент div какой-нибудь новый элемент:

    d3.select("div.red").append('h2').text('Заголовок');
Метод append принимает название тега. Все операторы, которые идут по цепочке после метода append, применяются уже к создаваемому элементу. так, в данном случае вызов метода text() будет относиться к создаваемому элементу h2, а не к выбранному ранее элементу div.

Метод insert() принимает два параметра:

    d3.select("body").insert('h2', 'div.blue').text('Заголовок');
Создаваемый элемент - в данном случае заголовок h2 добавляется перед первым найденным в body элементом div с классом blue.

Метод remove() удаляет элемент:

    d3.select('div.blue').remove();
    
    
Ключевым аспектом библиотеки D3.js является работа с данными. Для добавления данных в элемент применяется метод data(). В качестве аргумента в этот метод передается массив объектов.

Метод data() устанавливает связи между элементами html и элементами массива, однако чтобы выполнить привязку между элементом массива и текстом элемента html, надо использовать функцию динамической модификации (dynamic modifier function). Она принимает два параметра: d - элемент массива, и i - индекс элемента.

    <script type="text/javascript">
    var phones = ['iPhone 6', 'Samsung Galaxy S5', 'LG G4'];
    d3.selectAll('li').data(phones).text( function(d){
    return d;
    });
    </script>
    
Элементы массива выполняют роль данных, а элементы li, да и любые другие элементы html, являются визуальным представлением этих данных.

И хотя данный способ работает, но он очень ограничен. Например, что если мы получаем данные с сервера и заведомо не знаем, сколько будет элементов в списке. И если список ul будет содержать только один элемент li, а массив данных - больше одного, то в результате заполнится только один единственный элемент списка.

Используем паттерн enter-update-exit:
    <ul>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    </ul>
    <script type="text/javascript">
    var phones = ['iPhone 6', 'Samsung Galaxy S5', 'LG G4', 'MiPad 5'];
    // Enter
    d3.select('ul').selectAll('li').data(phones).enter().append('li');
    // Update
    d3.select('ul').selectAll('li').data(phones).text( function(d){ return d; });
    // Exit
    d3.select('ul').selectAll('li').data(phones).exit().remove();
    </script>

Итак, в массиве у нас четыре элемента, а в списке ul - шесть, то есть два лишних. Вначале применяем блок Enter, где используется метод enter(). После этого метода определяется добавление недостающих элементов li: .enter().append('li'). Но когда выполнение скрипта дойдет ло этой строчки, то добавление не будет работать, так как у нас нет недостающих элементов li, а, наоборот, есть только лишние.

Далее срабатывает блок Update. В нем производится обновление элементов li - установки их текста с помощью элементов из массива и функции function(d){ return d; }. Так как в массиве 4 элемента, то для первых четырех элементов из списка ul будет установлено текстовое содержимое. При этом два последних элемента окажутся пустыми.

Далее срабатывает блок Exit, суть которого в отсечении лишних элементов. Для этого используется метод .exit(), который определяет те элементы, которые не связаны с данными из массива. Затем идет удаление этих элементов с помощью метода remove()

Таким образом, если данных в массиве больше, чем визуальных элементов в коде html, то срабатывает вызовы после метода enter(). Если же наоборот, данных в массиве меньше, чем элементов html, то срабатывают методы после вызова exit(). И вне зависимости от количества элементов будет работать обновление.

При работе с данными мы можем полагаться на дополнительные функции, которые нам предлагает библиотека D3.js. Что представляют эти функции?

    d3.min(data): возвращает минимальное значение в массиве data

    d3.max: возвращает максимальное значение

    d3.extent: возвращает минимальное и максимальное значения в виде массива из двух элементов

    d3.sum: возвращает сумму всех элементов массива

    d3.median: возвращает медиану массива

    d3.mean: получает среднее значение

    d3.ascending / d3.descending: представляют функции, упорядочивающие массив по возрастанию / по убыванию

    d3.quantile: возвращает квантиль элементов массива, отсортированного по возрастанию

    d3.bisect: функция, которая возвращает позицию в отсортированном массиве, куда можно поместить определенный объект, не нарушая порядка возрастания.

    d3.nest: представляет функцию, которая преобразует некоторый массив объект в другую иерархическую структуру, более удобную для визуализации данных
    
    С помощью функции filter() можно осуществить фильтрацию данных, что позволит управлять их визуализацией.
    
Ключевой задачей при визуализации данных является их сопоставление с визуальными элементами. Чтобы упростить процесс сопоставления D3 предоставляет специальные конструкции, которые называются scale. Однако роль scale только сопоставлением не ограничивается, они также могут служить в качестве строительных кирпичиков более сложных конструкций в d3.

Что же представляет scale? scale можно представить в качестве математической функции, которая преобразует некоторое значение из одного интервала, который называется domain, в значение, принадлежащее другому интервалу, который называется range.

Рассмотрим простейший пример. Так, у нас есть курс валют. Например, курс рубля по отношению к доллару на некотором временном промежутке изменялся и представляет следующие значения: 64, 62, 63, 59, 60, 57. То есть мы можем прикинуть примерный диапазон разброса значений - от 50 до 70 рублей за доллар. Диапазон от 50 до 70 и будет выполнять роль интервала domain.

Допустим, нам надо представить изменение курса валюты на графике, например, по оси Х. Но чтобы все выглядело более менее нам надо масштабировать интервал [50, 70] на некоторый отрезок оси X, например, на отрезок от 0 до 50. Для этого и надо использовать функцию scale.

С помощью d3 мы можем сделать подобное сопоставление следующим образом:

    var data =[64, 62, 63, 59, 60, 57];
 
    var linear = d3.scale.linear()
    .domain([50, 70])
    .range([1, 50]);

    for(var i=0; i<data.length; i++)
        console.log(linear(data[i]));
    Функция d3.scale.linear() будет автоматически сопоставлять значения из одного интервала со значениями из другого. В итоге консоль выведет следующие числа:

    35.3
    30.4
    32.85
    23.05
    25.5
    18.15
    Эти числа и будут представлять координаты по оси Х.
    
